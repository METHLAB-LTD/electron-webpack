{"version":3,"file":"WebpackDevServerManager.js","sourceRoot":"","sources":["../../src/dev/WebpackDevServerManager.ts"],"names":[],"mappings":"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","sourcesContent":["import chalk from \"chalk\"\nimport { ChildProcess } from \"child_process\"\nimport * as path from \"path\"\nimport { createConfigurator } from \"../main\"\nimport { statOrNull } from \"../util\"\nimport { ChildProcessManager, PromiseNotifier, run } from \"./ChildProcessManager\"\nimport { LineFilter, logError, logProcess, logProcessErrorOutput } from \"./devUtil\"\n\nconst debug = require(\"debug\")(\"electron-webpack\")\n\nfunction runWds(projectDir: string, env: any) {\n  const isWin = process.platform === \"win32\"\n  const webpackDevServerPath = path.join(projectDir, \"node_modules\", \".bin\", \"webpack-dev-server\" + (isWin ? \".cmd\" : \"\"))\n  debug(`Start renderer WDS ${webpackDevServerPath} on ${env.ELECTRON_WEBPACK_WDS_PORT} port`)\n  return run(webpackDevServerPath, [\"--color\", \"--env.autoClean=false\", \"--config\", path.join(__dirname, \"../../webpack.renderer.config.js\")], {\n    env,\n    cwd: projectDir,\n  })\n}\n\n// 1. in another process to speedup compilation\n// 2. some loaders detect webpack-dev-server hot mode only if run as CLI\nexport async function startRenderer(projectDir: string, env: any) {\n  const webpackConfigurator = await createConfigurator(\"renderer\", {production: false, configuration: {projectDir}})\n  const sourceDir = webpackConfigurator.sourceDir\n  // explicitly set to null - do not handle at all and do not show info message\n  if (sourceDir === null) {\n    return\n  }\n\n  const dirStat = await statOrNull(sourceDir)\n  if (dirStat == null || !dirStat.isDirectory()) {\n    logProcess(\"Renderer\", `No renderer source directory (${path.relative(projectDir, sourceDir)})`, chalk.blue)\n    return\n  }\n\n  if (webpackConfigurator.hasDependency(\"electron-next\")) {\n    debug(`Renderer WDS is not started - there is electron-next dependency`)\n    return\n  }\n\n  const lineFilter = new CompoundRendererLineFilter([\n    new OneTimeLineFilter(\"Project is running at \"),\n    new OneTimeLineFilter(\"webpack output is served from \"),\n  ])\n  return await new Promise((resolve: (() => void) | null, reject: ((error: Error) => void) | null) => {\n    let devServerProcess: ChildProcess | null\n    try {\n      devServerProcess = runWds(projectDir, env)\n    }\n    catch (e) {\n      reject!(e)\n      return\n    }\n\n    //tslint:disable-next-line:no-unused-expression\n    new ChildProcessManager(devServerProcess, \"Renderer WDS\", new PromiseNotifier(resolve, reject))\n    devServerProcess.on(\"error\", error => {\n      if (reject == null) {\n        logError(\"Renderer\", error)\n      }\n      else {\n        reject(error)\n        reject = null\n      }\n    })\n\n    devServerProcess.stdout.on(\"data\", (data: string) => {\n      logProcess(\"Renderer\", data, chalk.blue, lineFilter)\n\n      const r = resolve\n      // we must resolve only after compilation, otherwise devtools disconnected\n      if (r != null && data.includes(\": Compiled successfully.\")) {\n        resolve = null\n        r()\n      }\n    })\n\n    logProcessErrorOutput(\"Renderer\", devServerProcess)\n  })\n}\n\nclass OneTimeLineFilter implements LineFilter {\n  private filtered = false\n\n  constructor(private readonly prefix: string) {\n  }\n\n  filter(line: string) {\n    if (!this.filtered && line.startsWith(this.prefix)) {\n      this.filtered = true\n      return false\n\n    }\n    return true\n  }\n}\n\nclass CompoundRendererLineFilter implements LineFilter {\n  constructor(private readonly filters: Array<LineFilter>) {\n  }\n\n  filter(line: string) {\n    return !this.filters.some(it => !it.filter(line))\n  }\n}"]}
