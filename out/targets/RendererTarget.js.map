{"version":3,"file":"RendererTarget.js","sourceRoot":"","sources":["../../src/targets/RendererTarget.ts"],"names":[],"mappings":"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","sourcesContent":["import { outputFile } from \"fs-extra-p\"\nimport { Lazy } from \"lazy-val\"\nimport * as path from \"path\"\nimport { getConfig } from \"read-config-file\"\nimport { DefinePlugin } from \"webpack\"\nimport { getDllAssets } from \"../configurators/dll\"\nimport { configureVueRenderer } from \"../configurators/vue/vue\"\nimport { WebpackConfigurator } from \"../main\"\nimport { statOrNull } from \"../util\"\nimport { BaseTarget, configureFileLoader } from \"./BaseTarget\"\n\nconst MiniCssExtractPlugin = require(\"mini-css-extract-plugin\")\n\nexport class BaseRendererTarget extends BaseTarget {\n  constructor() {\n    super()\n  }\n\n  configureRules(configurator: WebpackConfigurator): void {\n    super.configureRules(configurator)\n\n    configurator.extensions.push(\".css\")\n\n    const cssHotLoader = configurator.isProduction ? [MiniCssExtractPlugin.loader] : [\"css-hot-loader\", MiniCssExtractPlugin.loader]\n    if (!configurator.isProduction) {\n      // https://github.com/shepherdwind/css-hot-loader/issues/37\n      configurator.entryFiles.unshift(\"css-hot-loader/hotModuleReplacement\")\n    }\n\n    configurator.rules.push(\n      {\n        test: /\\.css$/,\n        use: cssHotLoader.concat(\"css-loader\"),\n      },\n      {\n        test: /\\.less$/,\n        use: cssHotLoader.concat(\"less-loader\"),\n      },\n      {\n        test: /\\.scss/,\n        use: cssHotLoader.concat(\"sass-loader\"),\n      },\n      {\n        test: /\\.(png|jpe?g|gif|svg)(\\?.*)?$/,\n        use: {\n          loader: \"url-loader\",\n          options: configureFileLoader(\"imgs\")\n        }\n      },\n      {\n        test: /\\.(mp4|webm|ogg|mp3|wav|flac|aac)(\\?.*)?$/,\n        loader: \"url-loader\",\n        options: configureFileLoader(\"media\"),\n      },\n      {\n        test: /\\.(woff2?|eot|ttf|otf)(\\?.*)?$/,\n        use: {\n          loader: \"url-loader\",\n          options: configureFileLoader(\"fonts\")\n        }\n      },\n    )\n\n    if (configurator.hasDevDependency(\"ejs-html-loader\")) {\n      configurator.rules.push({\n        test: /\\.ejs$/,\n        loader: \"ejs-html-loader\",\n      })\n    }\n\n    if (configurator.hasDependency(\"vue\")) {\n      configureVueRenderer(configurator)\n    }\n    else {\n      configurator.rules.push({\n        test: /\\.(html)$/,\n        use: {\n          loader: \"html-loader\",\n        }\n      })\n    }\n  }\n\n  async configurePlugins(configurator: WebpackConfigurator): Promise<void> {\n    configurator.debug(\"Add ExtractTextPlugin plugin\")\n    configurator.plugins.push(new MiniCssExtractPlugin({filename: `${configurator.type === \"renderer-dll\" ? \"vendor\" : \"styles\"}.css`}))\n\n    // https://github.com/electron-userland/electrify/issues/1\n    if (!configurator.isProduction) {\n      configurator.plugins.push(new DefinePlugin({\n        \"process.env.NODE_ENV\": \"\\\"development\\\"\",\n      }))\n    }\n\n    await BaseTarget.prototype.configurePlugins.call(this, configurator)\n  }\n}\n\nexport class RendererTarget extends BaseRendererTarget {\n  constructor() {\n    super()\n  }\n\n  async configurePlugins(configurator: WebpackConfigurator): Promise<void> {\n    // not configurable for now, as in the electron-vue\n    const customTemplateFile = path.join(configurator.projectDir, \"src/index.ejs\")\n    const HtmlWebpackPlugin = require(\"html-webpack-plugin\")\n    const nodeModulePath = configurator.isProduction ? null : path.resolve(configurator.projectDir, \"node_modules\")\n\n    configurator.plugins.push(new HtmlWebpackPlugin({\n      filename: \"index.html\",\n      template: (await statOrNull(customTemplateFile)) == null ? (await generateIndexFile(configurator, nodeModulePath)) : customTemplateFile,\n      minify: false,\n      nodeModules: nodeModulePath\n    }))\n\n    if (configurator.isProduction) {\n      configurator.plugins.push(new DefinePlugin({\n        __static: `\"${path.join(configurator.projectDir, \"static\").replace(/\\\\/g, \"\\\\\\\\\")}\"`\n      }))\n    }\n    else {\n      const contentBase = [path.join(configurator.projectDir, \"static\"), path.join(configurator.commonDistDirectory, \"renderer-dll\")]\n      configurator.config.devServer = {\n        contentBase,\n        host: process.env.ELECTRON_WEBPACK_WDS_HOST || \"localhost\",\n        port: process.env.ELECTRON_WEBPACK_WDS_PORT || 9080,\n        hot: true,\n        overlay: true,\n      }\n    }\n\n    await BaseRendererTarget.prototype.configurePlugins.call(this, configurator)\n  }\n}\n\nasync function computeTitle(configurator: WebpackConfigurator): Promise<string | null | undefined> {\n  const titleFromOptions = configurator.electronWebpackConfiguration.title\n  if (titleFromOptions == null || titleFromOptions === false) {\n    return null\n  }\n\n  if (titleFromOptions !== true) {\n    return titleFromOptions\n  }\n\n  let title: string | null | undefined = (configurator.metadata as any).productName\n  if (title == null) {\n    const electronBuilderConfig = await getConfig<any>({\n      packageKey: \"build\",\n      configFilename: \"electron-builder\",\n      projectDir: configurator.projectDir,\n      packageMetadata: new Lazy(() => Promise.resolve(configurator.metadata))\n    })\n    if (electronBuilderConfig != null) {\n      title = electronBuilderConfig.result.productName\n    }\n  }\n\n  if (title == null) {\n    title = configurator.metadata.name\n  }\n  return title\n}\n\nasync function generateIndexFile(configurator: WebpackConfigurator, nodeModulePath: string | null) {\n  // do not use add-asset-html-webpack-plugin - no need to copy vendor files to output (in dev mode will be served directly, in production copied)\n  const assets = await getDllAssets(path.join(configurator.commonDistDirectory, \"renderer-dll\"), configurator)\n  const scripts: Array<string> = []\n  const css: Array<string> = []\n  for (const asset of assets) {\n    if (asset.endsWith(\".js\")) {\n      scripts.push(`<script type=\"text/javascript\" src=\"${asset}\"></script>`)\n    }\n    else {\n      css.push(`<link rel=\"stylesheet\" href=\"${asset}\">`)\n    }\n  }\n\n  const title = await computeTitle(configurator)\n  const filePath = path.join(configurator.commonDistDirectory, \".renderer-index-template.html\")\n  await outputFile(filePath, `<!DOCTYPE html>\n<html>\n  <head>\n    <meta charset=\"utf-8\">\n    ${title == null ? \"\" : `<title>${title}</title>`}\n    <script>\n      ${nodeModulePath == null ? \"\" : `require(\"module\").globalPaths.push(\"${nodeModulePath.replace(/\\\\/g, \"/\")}\")`}\n      require(\"source-map-support/source-map-support.js\").install()\n    </script>\n    ${scripts.join(\"\")}\n  ${css.join(\"\")}\n  </head>\n  <body>\n    <div id=\"app\"></div>\n  </body>\n</html>`)\n\n  return `!!html-loader?minimize=false!${filePath}`\n}"]}
