{"version":3,"file":"BaseTarget.js","sourceRoot":"","sources":["../../src/targets/BaseTarget.ts"],"names":[],"mappings":"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","sourcesContent":["import * as path from \"path\"\nimport { DefinePlugin, EnvironmentPlugin, HotModuleReplacementPlugin, LoaderOptionsPlugin } from \"webpack\"\nimport { configureDll } from \"../configurators/dll\"\nimport { configureEslint } from \"../configurators/eslint\"\nimport { createBabelLoader } from \"../configurators/js\"\nimport { WebpackConfigurator } from \"../main\"\nimport { WatchFilterPlugin } from \"../plugins/WatchMatchPlugin\"\nimport { WebpackRemoveOldAssetsPlugin } from \"../plugins/WebpackRemoveOldAssetsPlugin\"\n\nexport class BaseTarget {\n  configureRules(configurator: WebpackConfigurator): void {\n    const rules = configurator.rules\n\n    const babelLoader = createBabelLoader(configurator)\n    if (configurator.type !== \"main\" && configurator.hasDependency(\"iview\")) {\n      rules.push({\n        test: /iview.src.*?js$/,\n        use: babelLoader\n      })\n    }\n\n    rules.push(\n      {\n        test: /\\.js$/,\n        exclude: /(node_modules|bower_components)/,\n        use: babelLoader\n      },\n      {\n        test: /\\.node$/,\n        use: \"node-loader\"\n      },\n    )\n\n    if (configurator.hasDevDependency(\"nunjucks-loader\")) {\n      rules.push({\n        test: /\\.(njk|nunjucks)$/,\n        loader: \"nunjucks-loader\"\n      })\n    }\n\n    configureEslint(configurator)\n  }\n\n  async configurePlugins(configurator: WebpackConfigurator): Promise<void> {\n    const plugins = configurator.plugins\n\n    const dllManifest = await configureDll(configurator)\n    const mode = configurator.isProduction ? \"production\" : \"development\"\n\n    let optimization = configurator.config.optimization\n    if (optimization == null) {\n      optimization = {}\n      configurator.config.optimization = optimization\n    }\n\n    optimization.nodeEnv = mode\n    configurator.config.mode = mode\n\n    if (configurator.isProduction) {\n      if (configurator.env.minify !== false) {\n        const UglifyJsPlugin = require(\"uglifyjs-webpack-plugin\")\n        plugins.push(new UglifyJsPlugin({\n          parallel: true,\n          sourceMap: true,\n          uglifyOptions: {\n            compress: {\n              ecma: 7,\n            },\n          },\n        }))\n      }\n      optimization.minimize = true\n      plugins.push(new LoaderOptionsPlugin({minimize: true}))\n\n      // do not use ModuleConcatenationPlugin for HMR\n      // https://github.com/webpack/webpack-dev-server/issues/949\n      optimization.concatenateModules = true\n    }\n    else {\n      configureDevelopmentPlugins(configurator)\n    }\n\n    if (configurator.env.autoClean !== false) {\n      plugins.push(new WebpackRemoveOldAssetsPlugin(dllManifest))\n    }\n\n    optimization.noEmitOnErrors = true\n\n    const additionalEnvironmentVariables = Object.keys(process.env).filter(it => it.startsWith(\"ELECTRON_WEBPACK_\"))\n    if (additionalEnvironmentVariables.length > 0) {\n      plugins.push(new EnvironmentPlugin(additionalEnvironmentVariables))\n    }\n  }\n}\n\nexport function configureFileLoader(prefix: string, limit = 10 * 1024) {\n  return {\n    limit,\n    name: `${prefix}/[name]--[folder].[ext]`\n  }\n}\n\nfunction isAncestor(file: string, dir: string) {\n  return file.length > dir.length && file[dir.length] === path.sep && file.startsWith(dir)\n}\n\nfunction configureDevelopmentPlugins(configurator: WebpackConfigurator) {\n  const plugins = configurator.plugins\n  configurator.config.optimization!!.namedModules = true\n  plugins.push(new DefinePlugin({\n    __static: `\"${path.join(configurator.projectDir, \"static\").replace(/\\\\/g, \"\\\\\\\\\")}\"`\n  }))\n\n  plugins.push(new HotModuleReplacementPlugin())\n\n  if (configurator.hasDevDependency(\"webpack-build-notifier\")) {\n    const WebpackNotifierPlugin = require(\"webpack-build-notifier\")\n    plugins.push(new WebpackNotifierPlugin({\n      title: `Webpack - ${configurator.type}`,\n      suppressSuccess: \"initial\",\n      sound: false,\n    }))\n  }\n\n  if (configurator.hasDevDependency(\"webpack-notifier\")) {\n    const WebpackNotifierPlugin = require(\"webpack-notifier\")\n    plugins.push(new WebpackNotifierPlugin({title: `Webpack - ${configurator.type}`}))\n  }\n\n  // watch common code\n  let commonSourceDir = configurator.electronWebpackConfiguration.commonSourceDirectory\n  if (commonSourceDir == null) {\n    // not src/common, because it is convenient to just put some code into src to use it\n    commonSourceDir = path.join(configurator.projectDir, \"src\")\n  }\n\n  const alienSourceDir = configurator.getSourceDirectory(configurator.type === \"main\" ? \"renderer\" : \"main\")\n\n  configurator.plugins.push(new WatchFilterPlugin(file => {\n    return file === commonSourceDir || (isAncestor(file, commonSourceDir!!) && (alienSourceDir != null && !file.startsWith(alienSourceDir)))\n  }, require(\"debug\")(`electron-webpack:watch-${configurator.type}`)))\n}\n"]}
