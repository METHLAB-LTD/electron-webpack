{"version":3,"file":"WebpackRemoveOldAssetsPlugin.js","sourceRoot":"","sources":["../../src/plugins/WebpackRemoveOldAssetsPlugin.ts"],"names":[],"mappings":";;;;;;;AAAA,AAAO,AAAe,AAAM,AAAc;;;;;;;;;;AAC1C,AAAO,AAAE,AAAK,AAAE,AAAO,AAAE,AAAM,AAAS,AAAM,AAAY;;;;;;;;;;AAC1D,AAAO,AAAK,AAAI,AAAM,AAAM;;AAE5B,AAAO,AAAE,AAAoB,AAAE,AAAM,AAAS,AAE9C,AAAM;;;;;;;;;;;;AAAC,MAAM,AAAiB,oBAAG,AAAC,AAClC,AAAM;;AAAC,MAAM,AAAW;AAAI,AAAW,eAAE,AAAiB,AAAC;AAAhC;;;AAE3B,MAAM,AAAK,QAAG,AAAO,QAAC,AAAO,AAAC,SAAC,AAAwB,AAAC,AAExD,AAAM;;;2CAAC,AAAK,WAAe,AAAsB,gBAAE,AAAsB;AACvE,UAAM,AAAM,SAAkB,AAAE;AAChC,UAAM,AAAK,QAAkB,CAAC,AAAc,AAAC;AAC7C,QAAI,AAAc,iBAAG,AAAK;;AAC1B,WAAO,AAAK,MAAC,AAAM,SAAG,AAAC;AACrB,YAAM,AAAO,UAAG,AAAK,MAAC,AAAG,AAAG;AAE5B,YAAM,AAAU,aAAG,MAAM,AAAoB,kCAAC,AAAO,yBAAC,AAAO,AAAC,AAAC;;AAC/D,UAAI,AAAU,cAAI,AAAI,MAAE;AACtB,AAAQ;AACT;;AAED,UAAI,AAAc,gBAAE;AAClB,AAAM,eAAC,AAAI,KAAC,AAAO,AAAC;AACrB,aACI;AACH,AAAc,yBAAG,AAAI;AACtB;;AAED,AAAU,iBAAC,AAAI,AAAE;AAEjB,YAAM,AAAI,OAAkB,AAAE,GAjBP,CAkBvB,AAAmH;;AACnH,YAAM,AAAe,kBAAG,6BAAsB,AAAG,IAAC,AAAU,YAAE,AAAI,AAAC,AAAE;AACnE,cAAM,AAAQ,WAAG,AAAO,UAAG,AAAI,KAAC,AAAG,MAAG,AAAI;AAC1C,sCAAa,AAAQ,AAAC,UACnB,AAAI,KAAC,AAAI,AAAC,AAAE;AACX,cAAI,AAAM,UAAI,AAAI,QAAI,CAAC,AAAM,OAAC,AAAQ,UAAE,AAAI,AAAC,OAAE;AAC7C,mBAAO,AAAI;AACZ;;AAED,cAAI,AAAI,KAAC,AAAW,AAAE,eAAE;AACtB,AAAI,iBAAC,AAAI,KAAC,AAAI,AAAC;AACf,mBAAO,AAAI;AACZ,iBACI;AACH,mBAAO,AAAQ;AAChB,AACH;AAAC,AAAC,AACN,SAdS,AAAK;AAcb,OAhB6B,AAAe,EAgB1C,AAAW,AAAC;;AAEf,WAAK,MAAM,AAAK,SAAI,AAAe,iBAAE;AACnC,YAAI,AAAK,SAAI,AAAI,MAAE;AACjB,AAAM,iBAAC,AAAI,KAAC,AAAK,AAAC;AACnB;AACF;;AAED,AAAI,WAAC,AAAI,AAAE;;AACX,WAAK,MAAM,AAAK,SAAI,AAAI,MAAE;AACxB,AAAK,cAAC,AAAI,KAAC,AAAO,UAAG,AAAI,KAAC,AAAG,MAAG,AAAK,AAAC;AACvC;AACF;;AAED,WAAO,AAAM,AACf;AAAC,AAID,AAAM;;;;;;;;;;AACJ,cAA6B,AAA0B;AAA1B,SAAW,cAAX,AAAW,AAAe,AACvD;AAAC;;AAED,AAAK,QAAC,AAAkB;AACtB,AAAQ,aAAC,AAAK,MAAC,AAAS,UAAC,AAAQ,SAAC,AAA8B,gCAAE,CAAC,AAAgB,aAAE,AAAiC,AAAE,AAAE;AACxH,YAAM,AAAkB,qBAAG,AAAW,YAAC,AAAM;AAC7C,YAAM,AAAM,SAAG,AAAQ,SAAC,AAAO,QAAC,AAAO,OAAC,AAAK;AAC7C,AAAI,WAAC,AAAM,QAAE,CAAC,AAAI,MAAE,AAAI,AAAE,AAAE;AAC1B,AAAa;AACb,YAAI,AAAI,SAAK,AAAI,KAAC,AAAW,aAAE;AAC7B,iBAAO,AAAK;AACb;;AAED,cAAM,AAAY,eAAG,AAAI,KAAC,AAAS,UAAC,AAAM,OAAC,AAAM,SAAG,AAAC,AAAC;;AACtD,YAAI,AAAI,KAAC,AAAM,AAAE,UAAE;AACjB,iBAAO,AAAkB,mBAAC,AAAY,AAAC,iBAAI,AAAI;AAChD,eACI,IAAI,AAAI,KAAC,AAAW,AAAE,eAAE;AAC3B,eAAK,MAAM,AAAC,KAAI,AAAM,OAAC,AAAI,KAAC,AAAkB,AAAC,qBAAE;AAC/C,gBAAI,AAAC,EAAC,AAAM,SAAG,AAAY,aAAC,AAAM,AAAI,WAAC,AAAC,EAAC,AAAY,aAAC,AAAM,AAAC,YAAK,AAAG,OAAI,AAAC,EAAC,AAAY,aAAC,AAAM,AAAC,YAAK,AAAI,AAAC,SAAI,AAAC,EAAC,AAAU,WAAC,AAAY,AAAC,eAAE;AACvI,qBAAO,AAAK;AACb;AACF;;AACD,iBAAO,AAAI;AACZ;;AACD,eAAO,AAAK,AACd;AAAC,AAAC,SACC,AAAI,KAAE,AAAE,AAAO,AAAE,EAAZ;AACJ,YAAI,AAAE,GAAC,AAAM,WAAK,AAAC,GAAE;AACnB,iBAAO,AAAI;AACZ;;AAED,YAAI,AAAK,MAAC,AAAO,SAAE;AACjB,AAAK,AAAC,6CAA6B,AAAE,GAAC,AAAI,KAAC,AAAM,AAAC,OAAE,AAAC;AACtD;;AACD,eAAO,AAAe,uBAAC,AAAG,IAAC,AAAE,IAAE,AAAE,AAAC,AAAE,MAAC,AAAM,wBAAC,AAAE,AAAC,KAAE,AAAW,AAAC,AAC/D;AAAC,AAAC,SACD,AAAI,KAAC,AAAG,AAAE,MAAC,AAAQ,AAAE,AAAC,YACtB,AAAK,MAAC,AAAQ,AAAC,AACpB;AAAC,AAAC,AACJ;AAAC,AACF","sourcesContent":["import BluebirdPromise from \"bluebird-lst\"\nimport { lstat, readdir, remove, Stats } from \"fs-extra-p\"\nimport * as path from \"path\"\nimport { Compiler } from \"webpack\"\nimport { orNullIfFileNotExist } from \"../util\"\n\nexport const MAX_FILE_REQUESTS = 8\nexport const CONCURRENCY = {concurrency: MAX_FILE_REQUESTS}\n\nconst debug = require(\"debug\")(\"electron-webpack:clean\")\n\nexport async function walk(initialDirPath: string, filter?: Filter | null): Promise<Array<string>> {\n  const result: Array<string> = []\n  const queue: Array<string> = [initialDirPath]\n  let addDirToResult = false\n  while (queue.length > 0) {\n    const dirPath = queue.pop()!\n\n    const childNames = await orNullIfFileNotExist(readdir(dirPath))\n    if (childNames == null) {\n      continue\n    }\n\n    if (addDirToResult) {\n      result.push(dirPath)\n    }\n    else {\n      addDirToResult = true\n    }\n\n    childNames.sort()\n\n    const dirs: Array<string> = []\n    // our handler is async, but we should add sorted files, so, we add file to result not in the mapper, but after map\n    const sortedFilePaths = await BluebirdPromise.map(childNames, name => {\n      const filePath = dirPath + path.sep + name\n      return lstat(filePath)\n        .then(stat => {\n          if (filter != null && !filter(filePath, stat)) {\n            return null\n          }\n\n          if (stat.isDirectory()) {\n            dirs.push(name)\n            return null\n          }\n          else {\n            return filePath\n          }\n        })\n    }, CONCURRENCY)\n\n    for (const child of sortedFilePaths) {\n      if (child != null) {\n        result.push(child)\n      }\n    }\n\n    dirs.sort()\n    for (const child of dirs) {\n      queue.push(dirPath + path.sep + child)\n    }\n  }\n\n  return result\n}\n\nexport type Filter = (file: string, stat: Stats) => boolean\n\nexport class WebpackRemoveOldAssetsPlugin {\n  constructor(private readonly dllManifest: string | null) {\n  }\n\n  apply(compiler: Compiler) {\n    compiler.hooks.afterEmit.tapAsync(\"WebpackRemoveOldAssetsPlugin\", (compilation: any, callback: (error?: Error) => void) => {\n      const newlyCreatedAssets = compilation.assets\n      const outDir = compiler.options.output!.path!\n      walk(outDir, (file, stat) => {\n        // dll plugin\n        if (file === this.dllManifest) {\n          return false\n        }\n\n        const relativePath = file.substring(outDir.length + 1)\n        if (stat.isFile()) {\n          return newlyCreatedAssets[relativePath] == null\n        }\n        else if (stat.isDirectory()) {\n          for (const p of Object.keys(newlyCreatedAssets)) {\n            if (p.length > relativePath.length && (p[relativePath.length] === \"/\" || p[relativePath.length] === \"\\\\\") && p.startsWith(relativePath)) {\n              return false\n            }\n          }\n          return true\n        }\n        return false\n      })\n        .then((it): any => {\n          if (it.length === 0) {\n            return null\n          }\n\n          if (debug.enabled) {\n            debug(`Remove outdated files:\\n  ${it.join(\"\\n  \")}`)\n          }\n          return BluebirdPromise.map(it, it => remove(it), CONCURRENCY)\n        })\n        .then(() => callback())\n        .catch(callback)\n    })\n  }\n}\n"]}
